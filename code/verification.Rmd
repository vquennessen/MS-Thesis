---
title: "verification"
output: rmarkdown::html_vignette
vignette: >
%\VignetteIndexEntry{verification_vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  ---
  
```{r, include = FALSE}
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
```

```{r, echo = FALSE}
library(remotes)
remotes::install_github('vquennessen/densityratio')
library(densityratio)
library(abind)
library(ggplot2)
```
# Set the parameters that are the same for all scenarios
```{r}
# Species
Species = 'BR_CA_2003'
# set arguments
R0 = 1e+5
A = 5; MPA = 3
Time1 = 50; Time2 = 50
M_Error = 0; Sampling_Error = FALSE; Stochasticity = FALSE
Surveys = TRUE; Fishery_management = TRUE; Fishing = TRUE; Transects = 24
Plotting = FALSE
Final_DRs = c(1); Floor_DR = 0.2
Years_sampled = NULL; Areas_sampled = NULL; Ind_sampled = NULL
BM = TRUE; Control_rules = c(1:8)
Output.FM = FALSE; Output.N = FALSE
Output.Abundance = FALSE; Output.Biomass = FALSE; Output.SSB = TRUE
Output.Catch = FALSE; Output.Yield = TRUE
Output.Effort = TRUE; Output.Density.Ratio = FALSE
Condensed.Output = FALSE
```

# Run the scenarios across all recruitment modes, adult movemement rates, and effort allocations. 
```{r}
Rmodes <- c('closed', 'regional_DD', 'local_DD', 'pool', 'closed')
LDPs <- c(0, 0, 0, 0, 0.10)
Adult_M <- c(TRUE, FALSE)
Allocations <- c('IFD', 'equal')
S <- length(Rmodes) * length(Adult_M) * length(Allocations)

for (r in 1:length(Rmodes)) {
  for (am in 1:length(Adult_M)) {
    for (a in 1:length(Allocations)) {
      
      LDP <- LDPs[r]
      Recruitment_mode <- Rmodes[r]
      Adult_movement <- Adult_M[am]
      Allocation <- Allocations[a]
      
      output <- base_model(Species, R0, A, MPA, Time1, Time2, 
                           Recruitment_mode, M_Error, Sampling_Error, 
                           Stochasticity, Surveys, Fishery_management, Fishing, 
                           Transects, Adult_movement, Plotting, Final_DRs, 
                           Years_sampled, Areas_sampled, Ind_sampled, Floor_DR, 
                           Allocation, BM, LDP, Control_rules, Output.FM, 
                           Output.N, Output.Abundance, Output.Biomass, 
                           Output.SSB, Output.Catch, Output.Yield,
                           Output.Effort, Output.Density.Ratio, Condensed.Output)
      
    # save the relative SSB and yield as a sum across all areas, 
    # times after reserve implementation, control rules, and scenarios
    if (exists("sims_SSB") == FALSE) {
      sims_SSB <- colSums(output$SSB)
      sims_yield <- colSums(output$Yield)
      sims_effort <- output$Effort
    } else { 
      sims_SSB <- abind(sims_SSB, colSums(output$SSB), along = 3)
      sims_yield <- abind(sims_yield, colSums(output$Yield), along = 3)
      sims_effort <- abind(sims_effort, output$Effort, along = 3) }
    }
  }
}
```

# Calculate the average SSB at the end of each decade and the average yield across decades
```{r}
# end of decade years
years <- seq(11, 51, by = 10)
decades <- 1:length(years)

# initialize data frame
data <- data.frame(Control.Rule = rep(Control_rules, each = length(decades)), 
                   Decade = rep(decades, times = length(Control_rules)),
                   SSB = rep(0, length(Control_rules)*length(decades)), 
                   yield = rep(0, length(Control_rules)*length(decades)))

# initialize relative SSB and yield arrays
rel_SSB <- array(rep(0, (Time2 + 1)*length(Control_rules)*S), 
                 c(Time2 + 1, length(Control_rules), S))
rel_yield <- array(rep(0, (Time2 + 1)*length(Control_rules)*S), 
                 c(Time2 + 1, length(Control_rules), S))

# calculate relative SSB and yield
for (t in 1:(Time2 + 1)) {
  for (cr in 1:length(Control_rules)) {
    for (s in 1:S) {
      rel_SSB[t, cr, s] <- sims_SSB[t, cr, s] / sims_SSB[1, cr, s]
      rel_yield[t, cr, s] <- sims_yield[t, cr, s] / sims_yield[1, cr, s]
    }
  }
}

# fill in average SSB at the end of decades and yield across decades
for (cr in 1:length(Control_rules)) {
  for (d in 1:length(decades)) {
    index <- (cr - 1)*length(decades) + d
    data$SSB[index] <- mean(rel_SSB[years[d], cr, ])
    data$yield[index] <- mean(rel_yield[(years[d] - 10):years[d], cr, ])
  }
}

# plot Figure 4a
ggplot(data, aes(x = Control.Rule, y = SSB, fill = as.factor(Decade))) + 
  geom_bar(stat = 'identity', position = 'dodge')
```
